<% include ../fragments/header.ejs %>

<% if (grants) { %>
	<div class="alert alert-danger alert-dismissible fade show" role="alert">
		<strong>Warning!</strong> You still need to link your Amazon Account via the Alexa App!
		<button type="button" class="close" data-dismiss="alert" aria-label="Close">
		<span aria-hidden="true">&times;</span>
		</button>
	</div>
<% } %>

<div class="container main-content">
	<h1>Devices for User: <%= user.username %></h1>
	<h3>Total Count: <%= count %></h3>
	<table class="table table-striped">
		<thead>
			<tr>
				<th scope="col">Name</th>
				<th scope="col">Description</th>
				<th scope="col">Capabilities</th>
				<th scope="col">Manage</th>
			</tr>
		</thead>
		<tbody>
			<% devices.forEach(function(device){ %>
				<tr>
					<th scope="row"><%= device.friendlyName %></th>
					<td><%= device.description %></td>
					<td>
						<% device.capabilities.forEach(function(action){ %>
							<img class="action" src="/images/<%= action %>.png" title="<%= action %>">
						<% }); %>
					</td>
					<td>
						<button type="button" class="btn btn-secondary" onclick="edit('<%= device._id %>')">Edit</button>
						<button type="button" class="btn btn-secondary" onclick="deleteDevice('<%= device._id%>')">Delete</button>
					</td>
				</tr>
			<% }); %>
		</tbody>
	</table>
	<div style="padding-top: 10px;">
		<button type="button" class="btn btn-secondary" onclick="addDevice();">Add Device</button>
	</div>
	<br />
	<p>After making any changes remember to ask Alexa to update devices it knows about by saying "Alexa, discover devices"</p>
</div>

<% include ../fragments/device-modal.ejs %>

<script>
		
$("#form-device").submit(function(e) {
	e.preventDefault();
	saveDevice()
});

// Enable/ disable minimumValue/ maximumValue and scale elements
$("#ThermostatController").change(function(e) {
	if ( $(this).is(':checked') == false) {
		$('#validRangeOptions').hide();
		$('#validRangeScaleOptions').hide();
		$('#maximumValue').attr("disabled", "disabled"); 
		$('#minimumValue').attr("disabled", "disabled");
		$('#Celsius').attr("disabled", "disabled"); 
		$('#Farenheit').attr("disabled", "disabled");
		$("#maximumValue").prop('required',false);
		$("#minimumValue").prop('required',false);
		$("#Celsius").prop('required',false);
		$("#Farenheit").prop('required',false);
	}
	else {
		$('#validRangeOptions').show();
		$('#validRangeScaleOptions').show();
		$('#maximumValue').removeAttr("disabled"); 
		$('#minimumValue').removeAttr("disabled");
		$('#Celsius').removeAttr("disabled");
		$('#Farenheit').removeAttr("disabled");
		$("#maximumValue").prop('required',true);
		$("#minimumValue").prop('required',true);
		$("#Celsius").prop('required',true);
		$("#Farenheit").prop('required',true);
	}
});

// Enable/ disable minimumValue/ maximumValue elements
$("#ColorTemperatureController").change(function(e) {
	if ( $(this).is(':checked') == false ) {
		$('#validRangeOptions').hide();
		$('#maximumValue').attr("disabled", "disabled"); 
		$('#minimumValue').attr("disabled", "disabled");
		$("#maximumValue").prop('required',false);
		$("#minimumValue").prop('required',false);
	}
	else {
		$('#validRangeOptions').show();
		$('#maximumValue').removeAttr("disabled"); 
		$('#minimumValue').removeAttr("disabled");
		$("#maximumValue").prop('required',true);
		$("#minimumValue").prop('required',true);
	}
});

function saveDevice() {
	var devID = $('#devID').val();

	// Add New Device
	if ( devID === "") {
		var device = {
			capabilities: [],
			displayCategories: [],
		};
		device.friendlyName = $('#friendlyName').val();
		device.description = $('#description').val();

		if ($('#ThermostatController').prop('checked') || $('#ColorTemperatureController').prop('checked')) {
			var scale;
			$('input[name=radioScale]').each(function(index){
				if (this.checked) {
					scale = this.value;
				}
			});
		}
		if ($('#ThermostatController').prop('checked') || $('#ColorTemperatureController').prop('checked')) {
			device.validRange = {
					minimumValue: $('#minimumValue').val(),
					maximumValue: $('#maximumValue').val(),
					scale: scale
				}
		}

		$('input[name=capabilities]').each(function(index){
			if (this.checked) {
				device.capabilities.push(this.value);
			}
		});
		$('input[name=appType]').each(function(index){
			if (this.checked) {
				device.displayCategories.push(this.value);
			}
		});

		if ($('#ReportState').prop('checked')) {
			device.reportState = true;
		}
		else {device.reportState = false}

		if (device.friendlyName && device.description && device.capabilities.length > 0) {
			$.ajax({
				url:"/devices",
				type: 'PUT',
				data: JSON.stringify(device),
				dataType: 'json',
				contentType: "application/json",
				success: function(data){
					//console.log(data);
					//reload
					document.location.reload();
				}
			}).fail(function(){
				alert("failed to create device");
			});
		} else {
			alert("Name or desciption can not be empty and at least one action is needed");
		}
	} else {
		// Modify Existing Device
		var device = devices[devID];
		device.description = $('#description').val();

		if ($('#ThermostatController').prop('checked') || $('#ColorTemperatureController').prop('checked')) {
			var scale;
			$('input[name=radioScale]').each(function(index){
				if (this.checked) {
					scale = this.value;
				}
			});
		}
		if ($('#ThermostatController').prop('checked') || $('#ColorTemperatureController').prop('checked')) {
			device.validRange = {
					minimumValue: $('#minimumValue').val(),
					maximumValue: $('#maximumValue').val(),
					scale: scale
				}
		}

		device.capabilities = [];
		$('input[name=capabilities]').each(function(index){
			if (this.checked) {
				device.capabilities.push(this.value);
			}
		});
		device.displayCategories = [];
		$('input[name=appType]').each(function(index){
			if (this.checked) {
				device.displayCategories.push(this.value);
			}
		});

		if ($('#ReportState').prop('checked')) {
			device.reportState = true;
		}
		else {device.reportState = false}

		if (device.friendlyName && device.description && device.capabilities.length > 0) {
			//post update
			$.ajax({
				url: '/device/' + device._id,
				type: 'POST',
				data: JSON.stringify(device),
				dataType: 'json',
				contentType: "application/json",
				success: function(data){
					//console.log("post response");
					//console.log(data);
					//reload
					document.location.reload();
				},
			});
			// console.log(JSON.stringify(device));
		} else {
			alert("Name or desciption can not be empty and at least one action is needed");
		}
	}
	//$('#newDeviceModal').hide();
}

function addDevice() {
	clearDevice();
	checkCapability();
	$("#newDeviceModal").modal();
	//$("#dialog").dialog("open");
}

function clearDevice() {
	$('#devID').val("");
	$('#friendlyName').val("");
	$('#friendlyName').prop('readonly', false);
	$('#description').val("");
	$('input[name=capabilities]').each(function(index){
		this.checked = false;
	});
	$('input[name=appType]').each(function(index) {
		this.checked = false;
	});
	$('#ReportState').prop('checked', false)
	$('#validRangeOptions').hide();
	$('#validRangeScaleOptions').hide();
	$('#maximumValue').val(""); 
	$('#minimumValue').val("");
	$('#maximumValue').attr("disabled", "disabled"); 
	$('#minimumValue').attr("disabled", "disabled");
	$('#Celsius').attr("disabled", "disabled"); 
	$('#Farenheit').attr("disabled", "disabled");
	$("#maximumValue").prop('required',false);
	$("#minimumValue").prop('required',false);
	$("#Celsius").prop('required',false);
	$("#Farenheit").prop('required',false);
	$('input[name=radioScale]').each(function(index){
		this.checked = false;
	});
}

function edit(id) {
	clearDevice();
	$("#newDeviceModal").modal();
	var device = devices[id];
	$('#devID').val(device._id);
	$('#friendlyName').val(device.friendlyName);
	$('#friendlyName').prop('readonly', true);
	$('#description').val(device.description);
	device.capabilities.forEach(function(action){
		$('#' + action).prop('checked',true);
	});
	device.displayCategories.forEach(function(type){
		$('#' + type).prop('checked',true);
	});

	// ColorTemperatureController
	var colorTemperature = $('#ColorTemperatureController').prop('checked');
	var thermostat = $('#ThermostatController').prop('checked');

	// reportState Boolean
	if (device.hasOwnProperty('reportState')) {
		if (device.reportState == true) {$('#ReportState').prop('checked', true)};
		if (device.reportState == false) {$('#ReportState').prop('checked', false)};
	}

	// Handle min/max and scale values, only show if ThermostatController or ColorTemperatureController
	if (device.hasOwnProperty('validRange') && ( colorTemperature || thermostat ) ) {
		validRange = device.validRange;
		if (validRange.hasOwnProperty('scale')) {
			$('#validRangeScaleOptions').show();
			$('#Celsius').removeAttr("disabled");
			$('#Farenheit').removeAttr("disabled");
			$("#Celsius").prop('required',true);
			$("#Farenheit").prop('required',true);
			$('#' + validRange.scale).prop('checked',true);
		}
		if (validRange.hasOwnProperty('maximumValue')) {
			$('#validRangeOptions').show();
			$("#maximumValue").prop('required',true);
			$('#maximumValue').removeAttr("disabled"); 
			$("#maximumValue").val(validRange.maximumValue);
		}
		if (validRange.hasOwnProperty('minimumValue')) {
			$('#validRangeOptions').show();
			$('#minimumValue').removeAttr("disabled");
			$("#minimumValue").prop('required',true);
			$("#minimumValue").val(validRange.minimumValue);
		}
		// Update Form Validation Requirements ??
	}
}

function deleteDevice(id) {
	var answer = confirm("Are you sure you want to delete this device?");
	if(answer) {
		$.ajax({
			url:"/device/" + id,
			type: 'DELETE',
			success: function(data){
				document.location.reload();
			}
		});
	}
}

function checkCapability(check) {
	// Restrictions HERE - i.e. StepVolume/ PlaybackControl can't go with ThermostatControl/ SceneControl
	if ($('#SceneController').prop('checked')) {
		alert("Activity/ Scene selected, this must be the only capability!");
		$('#ACTIVITY_TRIGGER').prop('checked', true);
		// Clear other capability/ type selections
		$('input[name=appType]').each(function(index){if ($(this).attr("id") != "ACTIVITY_TRIGGER") {$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		$('input[name=capabilities]').each(function(index){if ($(this).attr("id") != "SceneController"){$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		return false;
	}
	else if ($('#ThermostatController').prop('checked')) {
		alert("Thermostat selected, this must be the only capability!");
		$('#THERMOSTAT').prop('checked', true);
		// Clear other capability/ type selections
		$('input[name=appType]').each(function(index){if ($(this).attr("id") != "THERMOSTAT") {$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		$('input[name=capabilities]').each(function(index){if ($(this).attr("id") != "ThermostatController"){$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		return false;
	}
	else if ($('#LockController').prop('checked')) {
		alert("Lock selected, this must be the only capability!");
		$('#SMARTLOCK').prop('checked', true);
		// Clear other capability/ type selections
		$('input[name=appType]').each(function(index){if ($(this).attr("id") != "SMARTLOCK") {$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		$('input[name=capabilities]').each(function(index){if ($(this).attr("id") != "LockController"){$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		return false;
	}
	// Grouped Capabilities HERE
	else if ($('#ColorTemperatureController').prop('checked') || ($('#ColorTemperatureController').prop('checked') && $('#PowerController').prop('checked'))) {
			// Auto-select Activity (can be changed by user)
			$('#PowerController').prop('checked', true);
			$('#LIGHT').prop('checked', true);
			$('input[name=appType]').each(function(index){if ($(this).attr("id") != "LIGHT") {$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		}
	else if ($('#ColorController').prop('checked') || ($('#ColorController').prop('checked') && $('#PowerController').prop('checked'))) {
		// Auto-select Activity (can be changed by user)
		$('#PowerController').prop('checked', true);
		$('#LIGHT').prop('checked', true);
		$('input[name=appType]').each(function(index){if ($(this).attr("id") != "LIGHT") {$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
	}
	else if ($('#BrightnessController').prop('checked') || ($('#BrightnessController').prop('checked') && $('#PowerController').prop('checked'))) {
		// Auto-select Activity (can be changed by user)
		$('#PowerController').prop('checked', true);
		$('#LIGHT').prop('checked', true);
		$('input[name=appType]').each(function(index){if ($(this).attr("id") != "LIGHT") {$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
	}
	// Single Capabilities HERE
	else {
		if ($('#ChannelController').prop('checked')) {
			// Auto-select Activity (can be changed by user)
			$('#TV').prop('checked', true);
			$('input[name=appType]').each(function(index){if ($(this).attr("id") != "TV") {$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		}
		if ($('#InputController').prop('checked')) {
			// Auto-select Activity (can be changed by user)
			$('#TV').prop('checked', true);
			$('input[name=appType]').each(function(index){if ($(this).attr("id") != "TV") {$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		}
		else if ($('#PowerController').prop('checked')) {
			// Auto-select Activity (can be changed by user)
			$('#SWITCH').prop('checked', true);
			$('input[name=appType]').each(function(index){if ($(this).attr("id") != "SWITCH") {$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		}
		else if ($('#StepSpeaker').prop('checked')) {
			// Auto-select Activity (can be changed by user)
			$('#SPEAKER').prop('checked', true);
			$('input[name=appType]').each(function(index){if ($(this).attr("id") != "SPEAKER") {$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		}
		else if ($('#PlaybackController').prop('checked')) {
			// Auto-select Activity (can be changed by user)
			$('#TV').prop('checked', true);
			$('input[name=appType]').each(function(index){if ($(this).attr("id") != "TV") {$('input[id^='+$(this).attr("id")+']').prop("checked", false)}});
		}
		else {
			// De-select ALL Activity
			$('input[name=appType]').each(function(index){$('input[id^='+$(this).attr("id")+']').prop("checked", false)});
			return false;
		}
	}
}

var devices = {};
<%- JSON.stringify(devices) %>.forEach(function(device){
	devices[device._id] = device;
});
</script>
<% include ../fragments/footer.ejs %>