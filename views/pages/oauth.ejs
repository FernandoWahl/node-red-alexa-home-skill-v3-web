<% include ../fragments/header.ejs %>
  <div class="container main-content">
    <h1 class="h3 mb-3 font-weight-normal">Connect with <%= application.title %></h1>
    <form action="/auth/finish" method="post">
        <input name="transaction_id" value="<%= transaction_id %>" hidden>
        <input name="response_type" value="<%= response_type %>" hidden>
        <input name="client_id" value="<%= application.oauth_id %>" hidden>
        <input name="auth_url" value="<%= decodeURIComponent(currentURL) %>" hidden>
        <input name="scope" value="<%= scope.join(',') %>" hidden>

        <div>
            <p><%= application.title %> requires permission to:</p>
            <ul>
                <% scope.forEach(function(i){ %>
                    <li><%= map[i] %></li>
                <% });%>
            </ul>
            <% if (user) { %>
                <p>Click <em>Authorise</em> to allow <%= application.title %> access to your Node-RED Smart Home Control devices.</p>
            <% } else { %>
                <p>Please sign in using your Node-RED Smart Home Control account to allow <%= application.title %> access to your Node-RED Smart Home Control devices.</p>
                <p>Don't have a <em>Node-RED Smart Home Control</em> account? <a href='/newuser'>You can create one here.</a></p>
            <% } %>
        <div>

        <% if (user) { %>
            <% if (errors) { %>
              <p style="color: red"><%= errors %></p>
            <% } %>
            <div class="form-group">
                <p>Signed in as <strong><%= user.name%></strong>.</p>
                <a href="/logout?next=<%= currentURL %>">Not </a><%= user.username %>?
                <input class="btn btn-lg btn-secondary btn-block" type="submit" value="Authorise">
            </div>
        <% } else { %>
            <% if (errors) { %>
              <p style="color: red"><%= errors %></p>
            <% } %>
            <div class="form-group">
                <label for="username">Username: </label>
                <input type="text" id="username" name="username"/>
            </div>
            <div>
                <label for="password">Password: </label>
                <input type="password" id="password" name="password">
            </div>
            <div>
                <input class="btn btn-lg btn-secondary btn-block" type="submit" value="Authorise">
            </div>
        <% } %>

    </form>
  </div>
<% include ../fragments/footer.ejs %>