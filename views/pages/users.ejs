<% include ../fragments/header.ejs %>
	<div class="container main-content">
		<h1>User Accounts</h1>
		<table class="table table-striped">
			<thead>
				<tr>
				  <th scope="col">Username</th>
				  <th scope="col">Email Address</th>
				  <th scope="col">Country</th>
				  <th scope="col">Region</th>
				  <th scope="col">Edit</th>
				  <th scope="col">Delete</th>
				</tr>
			</thead>
			<tbody>
				<% users.forEach(function(account){ %>
					<tr>
						<th scope="row"><%= account.username %></th>
						<td><%= account.email %></td>
						<td><%= account.country %></td>
						<td><%= account.region %></td>
						<td><button type="button" class="btn btn-secondary" onclick="editAccount('<%= account.username %>')">Edit</button></td>
						<td><button type="button" class="btn btn-secondary" onclick="deleteAccount('<%= account.username %>')">Delete</button></td>
					</tr>
				<% }); %>
			</tbody>
		</table>
	</div>

	<!-- Modal -->
	<div class="modal fade" id="userModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered" role="document">
			  <div class="modal-content">
				<div class="modal-header">
				  <h5 class="modal-title" id="userModalTitle">Edit User</h5>
				  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				  </button>
				</div>
				<form class="form-user" id="form-user">
				<div class="modal-body">
					<div class="form-group">
						<label for="username">Username: </label>
						<input id="username" class="form-control" type="text" required>
						<br>
						<label for="email">Email Address:</label>
						<input type="email" id="email" class="form-control" required>
						<br>
						<label for="country" class="sr-only">Country</label>
						<input type="text" id="country" class="form-control" required>
						<input type="text" id="country_code" name="country_code" data-countrycodeinput="1" readonly="readonly" hidden />
					</div>
				</div>
				<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
						<button class="btn btn-primary" id="submit" type="submit" value="submit">Save</button>
						<!-- <button type="button" class="btn btn-primary" onclick='saveDevice()'>Save</button> -->
				</div>
				</form>
			</div>
		</div>
	</div>
	<script>

	$("#country").countrySelect();
	
	$("#form-device").submit(function(e) {
		e.preventDefault();
		saveAccount()
	});

	function clearModal() {
		$('#username').val("");
		$('#email').val("");
		$('#country').val("");
	}

	function saveAccount() {
		var username = $('#username').val();
		var account = users[username];
		var country = $("#country_code").val().trim();
		//account.username = $('#username').val();
		account.email = ('#email').val();
		account.country = ('#country').val();
		if (account.username && account.email && account.country) {
				//post update
				$.ajax({
					url: '/account/' + account.username,
					type: 'POST',
					data: JSON.stringify(account),
					dataType: 'json',
					contentType: "application/json",
					success: function(data){
						//console.log("post response");
						//console.log(data);
						//reload
						document.location.reload();
					},
				});
				console.log(JSON.stringify(account));
			} else {
				alert("Ensure email address and country are set!");
			}
	}
	
	function editAccount(username) {
		clearModal()
		var account = users[username];
		$('#username').prop('readonly', true);
		$('#username').val(account.username);
		$('#email').val(account.email);
		$('#country').val(account.country);
		$("#userModal").modal();
	}

	function deleteAccount(username) {
		var answer = confirm("Are you sure you want to delete this user account?");
		if(answer) {
			if(answer) {
				$.ajax({
					url:"/account/" + username,
					type: 'DELETE',
					success: function(data){
						document.location.reload();
					}
				});
			}
		}
	}

	var users = {};
	<%- JSON.stringify(users) %>.forEach(function(user){
		users[user.username] = user;
	});
	</script>
<% include ../fragments/footer.ejs %>